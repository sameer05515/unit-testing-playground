<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scan Media Files</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <style>
        .scan-container {
            max-width: 900px;
            margin: 2rem auto;
        }
        .status-card {
            min-height: 200px;
        }
        .progress-container {
            margin: 2rem 0;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            padding: 1rem;
            border-radius: 0.25rem;
        }
        .log-entry {
            margin: 0.25rem 0;
            padding: 0.25rem 0;
        }
        .log-entry.info {
            color: #4ec9b0;
        }
        .log-entry.warning {
            color: #dcdcaa;
        }
        .log-entry.error {
            color: #f48771;
        }
        .log-entry.success {
            color: #4ec9b0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-dark bg-primary">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="bi bi-search"></i> Media Files Scanner
            </span>
            <a href="/" class="btn btn-outline-light">
                <i class="bi bi-arrow-left"></i> Back to Browser
            </a>
        </div>
    </nav>

    <div class="container-fluid scan-container">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hdd"></i> Scan Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label class="form-label">Drive Path</label>
                        <input type="text" class="form-control" id="drivePath" value="E:\" readonly>
                        <small class="text-muted">Currently configured to scan E: drive</small>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">File Extensions</label>
                        <div class="form-control" style="min-height: 38px; padding-top: 0.5rem;">
                            <span class="badge bg-secondary me-1">.mp3</span>
                            <span class="badge bg-secondary me-1">.mp4</span>
                            <span class="badge bg-secondary me-1">.pdf</span>
                            <span class="badge bg-secondary me-1">.jpg</span>
                            <span class="badge bg-secondary me-1">.jpeg</span>
                            <span class="badge bg-secondary me-1">.flv</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <label class="form-label">Exclude Directories</label>
                        <textarea class="form-control" id="excludeDirs" rows="3" 
                                  placeholder="Enter directory names or paths to exclude (one per line or comma-separated)&#10;Examples:&#10;node_modules&#10;System Volume Information&#10;E:\Windows&#10;E:\Program Files"></textarea>
                        <small class="text-muted">
                            Enter directory names (e.g., "node_modules") or full paths (e.g., "E:\Windows"). 
                            One per line or comma-separated. Matching directories and their subdirectories will be excluded.
                        </small>
                    </div>
                </div>
                <div class="d-grid">
                    <button class="btn btn-primary btn-lg" id="startScanBtn" onclick="startScan()">
                        <i class="bi bi-play-fill"></i> Start Scan
                    </button>
                </div>
            </div>
        </div>

        <!-- Scan Status Card -->
        <div class="card mt-3 status-card" id="statusCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-activity"></i> Scan Status</h5>
            </div>
            <div class="card-body">
                <div id="scanStatus" class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                
                <!-- Progress Bar -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Progress</span>
                        <span id="progressText">0%</span>
                    </div>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" 
                             id="progressBar"
                             style="width: 0%">0%</div>
                    </div>
                </div>

                <!-- Statistics -->
                <div id="statsContainer" style="display: none;">
                    <div class="stats-grid" id="statsGrid">
                    </div>
                </div>

                <!-- Log Output -->
                <div class="mt-3">
                    <h6>Scan Log</h6>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry info">Ready to start scan...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let scanInProgress = false;
        let statusCheckInterval = null;

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function startScan() {
            if (scanInProgress) {
                alert('Scan is already in progress');
                return;
            }

            scanInProgress = true;
            document.getElementById('startScanBtn').disabled = true;
            document.getElementById('startScanBtn').innerHTML = '<i class="bi bi-hourglass-split"></i> Scanning...';
            document.getElementById('statusCard').style.display = 'block';
            document.getElementById('scanStatus').innerHTML = '<div class="spinner-border text-primary" role="status"></div><p class="mt-2">Initializing scan...</p>';
            document.getElementById('logContainer').innerHTML = '';
            addLog('Starting scan...', 'info');

            try {
                // Get exclude directories from textarea
                const excludeDirsText = document.getElementById('excludeDirs').value.trim();
                let excludeDirs = [];
                
                if (excludeDirsText) {
                    // Split by newlines and commas, then filter out empty strings
                    excludeDirs = excludeDirsText
                        .split(/[\n,]+/)
                        .map(dir => dir.trim())
                        .filter(dir => dir.length > 0);
                }

                if (excludeDirs.length > 0) {
                    addLog(`Excluding directories: ${excludeDirs.join(', ')}`, 'info');
                }

                const response = await fetch('/api/scan/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ excludeDirs: excludeDirs })
                });

                if (!response.ok) {
                    throw new Error('Failed to start scan');
                }

                const data = await response.json();
                addLog(`Scan started. Process ID: ${data.processId}`, 'success');
                
                // Start polling for status
                checkScanStatus();
                statusCheckInterval = setInterval(checkScanStatus, 2000); // Check every 2 seconds

            } catch (error) {
                addLog(`Error starting scan: ${error.message}`, 'error');
                scanInProgress = false;
                document.getElementById('startScanBtn').disabled = false;
                document.getElementById('startScanBtn').innerHTML = '<i class="bi bi-play-fill"></i> Start Scan';
            }
        }

        async function checkScanStatus() {
            try {
                const response = await fetch('/api/scan/status');
                if (!response.ok) {
                    throw new Error('Failed to get scan status');
                }

                const status = await response.json();

                if (status.status === 'running') {
                    updateScanProgress(status);
                } else if (status.status === 'completed') {
                    clearInterval(statusCheckInterval);
                    scanInProgress = false;
                    document.getElementById('startScanBtn').disabled = false;
                    document.getElementById('startScanBtn').innerHTML = '<i class="bi bi-play-fill"></i> Start Scan';
                    showScanResults(status);
                } else if (status.status === 'error') {
                    clearInterval(statusCheckInterval);
                    scanInProgress = false;
                    document.getElementById('startScanBtn').disabled = false;
                    document.getElementById('startScanBtn').innerHTML = '<i class="bi bi-play-fill"></i> Start Scan';
                    addLog(`Scan error: ${status.error}`, 'error');
                    document.getElementById('scanStatus').innerHTML = 
                        `<div class="alert alert-danger"><i class="bi bi-exclamation-triangle"></i> Scan failed: ${status.error}</div>`;
                } else if (status.status === 'idle') {
                    // No scan running
                }
            } catch (error) {
                console.error('Error checking scan status:', error);
            }
        }

        function updateScanProgress(status) {
            const progress = status.progress || 0;
            const filesFound = status.filesFound || 0;
            const currentFile = status.currentFile || '';

            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressBar').textContent = `${progress}%`;
            document.getElementById('progressText').textContent = `${progress}%`;

            document.getElementById('scanStatus').innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-arrow-repeat spin"></i> 
                    Scanning in progress... 
                    <strong>${filesFound}</strong> files found so far
                </div>
                ${currentFile ? `<small class="text-muted">Current: ${currentFile}</small>` : ''}
            `;

            if (status.lastLog) {
                addLog(status.lastLog.message, status.lastLog.type || 'info');
            }
        }

        function showScanResults(status) {
            const result = status.result;
            if (!result) return;

            addLog('Scan completed successfully!', 'success');
            document.getElementById('scanStatus').innerHTML = `
                <div class="alert alert-success">
                    <i class="bi bi-check-circle"></i> 
                    Scan completed successfully!
                </div>
            `;

            // Hide progress bar
            document.getElementById('progressContainer').style.display = 'none';

            // Show statistics
            document.getElementById('statsContainer').style.display = 'block';
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Files</div>
                    <div class="stat-value">${result.totalFiles.toLocaleString()}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Size</div>
                    <div class="stat-value">${result.totalSizeFormatted}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Duration</div>
                    <div class="stat-value">${result.scanDuration}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Scan Date</div>
                    <div class="stat-value" style="font-size: 1rem;">${new Date(result.scanDate).toLocaleString()}</div>
                </div>
            `;

            // Add file type breakdown
            if (result.filesByType) {
                let typeBreakdown = '<div class="mt-3"><h6>Files by Type</h6><ul class="list-group">';
                Object.entries(result.filesByType).forEach(([type, count]) => {
                    typeBreakdown += `<li class="list-group-item d-flex justify-content-between">
                        <span>${type}</span>
                        <span class="badge bg-primary">${count.toLocaleString()}</span>
                    </li>`;
                });
                typeBreakdown += '</ul></div>';
                statsGrid.innerHTML += typeBreakdown;
            }

            addLog(`Total files found: ${result.totalFiles}`, 'success');
            addLog(`Total size: ${result.totalSizeFormatted}`, 'success');
            addLog(`Duration: ${result.scanDuration}`, 'success');
        }

        // Check initial status on page load
        window.addEventListener('load', () => {
            checkScanStatus();
        });
    </script>
</body>
</html>

